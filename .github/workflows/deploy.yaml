name: Recipe Rush CI/CD
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        kubectl version --client
    
    - name: Setup Kubeconfig
      env:
        KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
      run: |
        mkdir -p ~/.kube
        echo "$KUBE_CONFIG" > ~/.kube/config
        chmod 600 ~/.kube/config
        kubectl config view --minify --output 'yaml' | head -20
    
    - name: Test Cluster Connection
      run: |
        kubectl version
        kubectl get nodes -o wide
    
    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f frontend-deployment.yaml -n recipe-rush --validate=false --server-side || true
        kubectl apply -f hpa.yaml -n recipe-rush --validate=false || true
        kubectl apply -f ingress.yaml -n recipe-rush --validate=false || true
        kubectl rollout status deployment/recipe-rush-frontend -n recipe-rush --timeout=300s || true
        
    - name: Verify Deployment
      run: |
        kubectl get pods,deployments,hpa,ingress,svc -n recipe-rush
        echo "ðŸš€ Recipe Rush Deployed Successfully!"
